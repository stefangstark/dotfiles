#!/usr/bin/env bash

cleanup() {
  # remove items from sketchybar
  sketchybar --set '/pytest-.*/' drawing=off

  # kill all processes whose parent is this process
  pkill -P $$
}

for sig in INT QUIT HUP TERM; do
  trap "
    cleanup
    trap - $sig EXIT
    kill -s $sig "'"$$"' "$sig"
done

trap cleanup EXIT

# TODO: add project name flag
project=$(basename $PWD)
for opt; do
  [[ $opt == "--find" ]] && select=find && continue
  [[ $opt == "--pytest" ]] && select=pytest && continue
  [[ $select == "find" ]] && findargs+=("$opt")
  [[ $select == "pytest" ]] && pytestargs+=("$opt")
done

find "${findargs[@]}" |
  entr -n $HOME/.config/sketchybar/plugins/pytest.sh $project "${pytestargs[@]}"
